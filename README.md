# 2018s-onion-team2 (Team Young-me)

## 1. Entity Function

### 1) Server
- 서버는 로그인된 클라이언트의 Github ID, IP Address, GPG Key ID 목록을 가지고 있음
- 서버는 새로운 클라이언트가 연결되면 클라이언트 목록을 업데이트함
- 서버는 주기적으로 client health check를 하여 클라이언트 목록을 업데이트함
- 서버는 클라이언트 목록이 업데이트 된 경우 클라이언트의 public key로 암호화된 클라이언트 목록을 각 클라이언트로 전송함

### 2) Client
- 서버의 health check에 응답함
- 로그인하는 경우에 경우 서버에 클라이언트의 등록을 요청함
- 로그아웃하는 경우에 서버에 클라이언트의 제거를 요청함
- 메시지와 최종 수신자까지의 경로를 각 거점이 되는 클라이언트의 public key로 순차적으로 암호화하여 송신함
- 메시지를 수신하면 복호화하여 자신이 최종 수신자인 경우 메시지를 화면에 표시하고 아닌 경우 다음 클라이언트로 전송함

## 2. Coummunication Protocol
### 1) Data Transfer
```
0                   1                   2                   3                 4
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         dst IP Address (4byte)                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Flag (1byte)(0x00)|                One Time key (4byte)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    One Time Key   | GitID Len(1byte) |           Timestamp (4byte)          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               Timestamp              |       Message Length (4byte)         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Message Length            |            Github ID (? byte)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               Github ID                                     |
+                                                                             +
                                  ...
+                                                                             +
|                                                                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              Message (?byte)                                |
+														                     +
							      ....
+														                     +
|														                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- dst IP Address (4 byte): 다음 목적지의 IP 주소
- Flag (1 byte)
	- 0x00 : 송신
	- 0x01 : 송신에 대한 응답
	- 0x02 : 리스트 업데이트
	- 0x04 : 하트비트(UDP)
- One Time Key (4 byte) : 송신자가 보낸 일회성 키를 의미하며, 수신자가 재응답시 해당 키를 포함하여 메시지를 송신하여야 한다.
- Git ID Len (1 byte) : 송신자의 Github ID의 길이를 나타내며, 최대 39byte를 초과할 수 없음
- Github ID (? < 40 byte) : 송신자의 Github ID
- Timestamp (4 byte) : 송신을 기준으로 설정한 타임스탬프 값
- Message Length (4 byte) : 송신자가 보낸 메시지의 크기
- Github ID (? byte) : 송신자의 Github ID를 나타내며, 최대 39바이트를 넘지 않는다.
- Message (? byte) : 송신자가 보낸 메시지

```
0                   1                   2                   3                 4
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         dst IP Address (4byte)                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Encrypted Data (?byte)                              |
+                                                                             +
                                  ...
+                                                                             +
|                                                                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

상기의 패킷 구조는 네트워크 서킷(Circuit)의 요소를 지나는 순서대로 다음 노드가 향해야할 IP와 함께 요소의 공개키(Public Key)로 암호화하여 전송된다.

수신 노드는 동일한 구조와 송신자가 송신한 One Time Key를 포함하여 다시 송신자에게 메시지를 전송한다. 다음은 각 노드에 번호가 있다고 가정하고, A에서 B로 3 -> 5 -> 4번 노드를 거쳐 전송되는 경우를 나타낸 것이다.

K<sub>3</sub> ( K<sub>5</sub> ( OTK, Git ID length, Git ID, Timestamp, Message Lenght, Message ),  IP<sub>4</sub> ), IP<sub>5</sub>

- K<sub>n</sub> : n번 요소의 공개키를 이용한 암호화
- OTK : One Time Key
- IP<sub>n</sub> : n번 요소의 IP

### 2) List Update
```
0                   1                   2                   3                 4
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Flag (1byte)(0x02)|			        One Time key (4byte)                 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    One Time Key   |  GitID Len(1byte) |          Publickey (8byte)          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Publickey (8byte)                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               Publickey               |            IP Address (4byte)       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              IP Address               |   Target GitID   |      Github      |
|                                       |   Length(1byte)  | ID (? < 40byte)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                 Github ID                                   |
+                                                                             +
                                    ...
+                                                                             +
|                                                                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Target Github ID                                  |
+                                                                             +
                                  ...
+                                                                             +
|                                                                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- Flag (1 byte)
	- 0x00 : 송신
	- 0x01 : 송신에 대한 응답
	- 0x02 : 리스트 업데이트
	- 0x04 : 하트비트(UDP)
- One Time Key (4 byte) : 송신자가 보낸 일회성 키를 의미하며, 수신자가 재응답시 해당 키를 포함하여 메시지를 송신하여야 한다.
- Git ID Len (1 byte) : 송신자의 Github ID의 길이를 나타내며, 최대 39byte를 초과할 수 없음
- Publickey (8 byte) : 리스트에 업데이트할 대상의 Publickey
- IP Address (4 byte) : 리스트에 업데이트할 대상의 IP 주소
- Target GitID Length (1 byte) : 송신자의 Github ID를 나타내며, 최대 39를 넘지 않는다.
- Github ID (? byte) : 송신자의 Github ID를 나타내며, 최대 39byte를 넘지 않는다.
- Target Github ID (? byte) : 리스트에 업데이트할 대상의 Github ID를 나타내며, 최대 39byte를 넘지 않는다.

### 3) Heatbeat
 Heartbeat는 디렉토리 서버(Directory Server)에서 노드 리스트를 관리하기 위함으로써, 특정 노드의 생존 여부를 위해 사용하며, 반드시 서버에서 해당 데이터를 먼저 전송한다. 이때 해당 패킷은 수신 노드의 공개키로 암호화된 UDP 패킷을 사용한다.
```
0                   1                   2                   3				 4
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Flag (1byte)(0x04)|                 One Time key (4byte)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    One Time Key   |                   Timestamp (4byte)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

해당 Heartbeat 메시지를 수신한 노드는 동일한 One Time Key를 내포한 패킷을 서버의 공개키로 암호화하여 다시 송신한다.

## Team Member
-----
| Name        |Position| Role              |
|-------------|-------------------|-------------------|
| Sooyoung Lee | PL | Server & Client Coding     |
| Seokjoo Mun | Member | Protocol Design & Server Coding    |
| Taekjin Lee | Member | Server & Client Coding |
| Seunghwan Hong | Member | Client Coding |